
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Login</title>
		<link rel="stylesheet" type="text/css" href="main.css">
		<script type='text/javascript' src='https://cdn.firebase.com/js/client/1.0.11/firebase.js'></script>
		<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
		<script type='text/javascript' src='http://code.jquery.com/jquery-1.11.0.min.js'></script>
  		<script>
    		WebFont.load({
      			google: {
        			families: ["Exo:100,200,300,400,500,600,700,800,900"]
		      }
		    });
	  </script>
	</head>
		<body>
			
			<div class="nav-bar">
				<a class="nav-text">SIGN UP/LOGIN</a>
			</div>
			<div>
			<div class="login-form">
				<div class="login-header"><p class="title">Sign up to play</p></div>
				
				<div class="content">
					<input name="username" type="text" id="usernameInput" placeholder="username" />
				<input name="password" type="password" id="passwordInput" placeholder="password" />
				</div>

				<div class="register-button">
					<div class="reg-button" id="reg-bttn">Register</div>
				</div>
			</div>
			</div>
		</body>
<script>

if(!(typeof(Storage)!=="undefined") {
    alert("Sorry this game is not supported on your browser");
    return;
}

/* Constants */
var NUM_FLAGS               = 200;
var FLAG_LIST_KEY           = "FLAG_LIST_KEY";
var RANKS_LIST_KEY          = "RANKS_LIST_KEY";
var NUM_USERS_KEY           = "NUM_USERS_KEY";
var flagTagUniqueStorageId  = "darth-vader-pooped-in-a-tree";

var storage = null;
var userDB = null;
var ranksDB = null;
var flagId = parseInt(getParameterByName("id"));
flagId = (flagId === NaN ? -1 : flagId);

storage = localStorage.getItem(flagTagUniqueStorageId);

db = new Firebase('https://blistering-fire-1331.firebaseio.com/');
ranksDB = new Firebase('https://blistering-fire-1331.firebaseio.com/' + RANKS_LIST_KEY);

var addUserToRanks = function(name) {
	/* Add to ranks */
	ranksDB.transaction(function(cur_ranks) {
		var num_users = cur_ranks[NUM_USERS_KEY];
		cur_ranks[num_users.toString()] = {
			username: name,
			flagCount: 0
		};
		cur_ranks[NUM_USERS_KEY]++;
		return cur_ranks;
	}, function(error committed, new_ranks) {
		if (error) {
			alert("Sorry! There was a problem logging in.");
		} else if (!committed) {
			addUserToRanks(name);
		} else {
			storage.username = username;
			var flagId = storage.recentFlagId;
			storage.recentFlagId = -1;
			localStorage.setItem(flagTagUniqueStorageId, storage);
			window.location.href = "ranks.html?id=" + (flagId === null ? "" : flagId);
		}
	});
}

$("#reg-bttn").click(function(e) {
	e.stopPropagation();
	e.preventDefault();
	db.once('value', function(dataSnapshot) {
		var username = $("#usernameInput").val();
	  	if (dataSnapshot.hasChild(username)) {
	  		alert("Sorry! username is taken");
			return;
	  	}
	  	var password = $("#passwordInput").val();
		dataSnapshot
		.child(username)
		.ref()
		.set({ 
			password: password,
			flags: {}
		}, function(error) {
			if (error) {
				alert("Firebase returned an error");
			} else {
				addUserToRanks(username);
			}
		});
	});
});
</script>
</html>