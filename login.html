
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Login</title>
		<link rel="stylesheet" type="text/css" href="main.css">
		<script type='text/javascript' src='https://cdn.firebase.com/js/client/1.0.11/firebase.js'></script>
		<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
		<script type='text/javascript' src='http://code.jquery.com/jquery-1.11.0.min.js'></script>
  		<script>
    		WebFont.load({
      			google: {
        			families: ["Exo:100,200,300,400,500,600,700,800,900"]
		      }
		    });
	  </script>
	</head>
		<body>
			
			<div class="nav-bar">
				<a class="nav-text">SIGN UP/LOGIN</a>
			</div>
			<div>
			<div class="login-form">
				<div class="login-header"><p class="title">Sign up to play</p></div>
				
				<div class="content">
					<input name="username" type="text" id="usernameInput" placeholder="username" />
				<input name="password" type="password" id="passwordInput" placeholder="password" />
				</div>

				<div class="register-button">
					<div class="reg-button" id="reg-bttn">Register</div>
				</div>
			</div>
			</div>
		</body>
<script>

if(!(typeof(Storage)!=="undefined")) {
    alert("Sorry this game is not supported on your browser");
    return;
}

/* Constants */
var NUM_FLAGS               = 200;
var FLAGS_KEY               = "FLAGS_KEY";
var USERS_KEY               = "USERS_KEY";
var flagTagStorageKeyBase	= "darth-vader-pooped-in-a-tree";
var flagTagStorageUserKey  	= flagTagStorageKeyBase + "-username";
var flagTagStorageFlagKey  	= flagTagStorageKeyBase + "-flagId";

var usersDB = new Firebase('https://blistering-fire-1331.firebaseio.com/' + USERS_KEY);

var updateDB = function(username, password) {
    usersDB.transaction(function(users) {
    	if (users == null) {
    		users = {};
    	}

    	/* Does another user exist? */
    	if (users[username] && users[username].password !== password) {
    		alert("Sorry! username is taken");
			return users;
    	}

    	/* Is user signing in? */
    	if (users[username] && users[username].password === password) {
    		return users;
    	}

        /* Add to users */
        users[username] = {
        	password: password,
        	flagCount: 0
        };

        return users;
    }, function(error, committed, new_data) {
    	if (error) {
    		alert("Sorry! Something went wrong. Please try again");
    	} else if (!committed) {
    		updateDB(username, password);
    	} else {
			var flagId = parseInt(localStorage.getItem(flagTagStorageFlagKey));
			if (isNaN(flagId)) {
				flagId = -1;
			}
			localStorage.removeItem(flagTagStorageFlagKey);
			localStorage.setItem(flagTagStorageUserKey, username);
			window.location.href = "ranks.html?id=" + (flagId === -1 ? "" : flagId);
    	}
    });
};

$("#reg-bttn").click(function(e) {
	e.stopPropagation();
	e.preventDefault();
	var username = $("#usernameInput").val();
	var password = $("#passwordInput").val();
	updateDB(username, password);
});

</script>
</html>